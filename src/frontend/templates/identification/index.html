<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞ –∏ —ç–º–æ—Ü–∏–π</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .drag-area {
            border: 2px dashed #4f46e5;
            transition: all 0.3s ease;
        }
        .drag-area.dragover {
            background: rgba(79, 70, 229, 0.1);
            border-color: #4338ca;
        }
        .recording-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .emotion-card {
            transition: all 0.3s ease;
        }
        .emotion-card:hover {
            transform: translateY(-5px);
        }
        .emotion-card.selected {
            border-color: #4f46e5;
            background-color: rgba(79, 70, 229, 0.1);
        }
    </style>
</head>
<body class="font-sans">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <a href="/" class="flex items-center text-gray-800 hover:text-gray-600">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
                        </svg>
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-3xl mx-auto">
            <div class="container-box rounded-xl shadow-xl p-8 mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
                
                <!-- –§–æ—Ä–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
                <form id="identificationForm" class="space-y-6">
                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ–º–æ–π —ç–º–æ—Ü–∏–∏ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-4">
                            –¢—Ä–µ–±—É–µ–º–∞—è —ç–º–æ—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </label>
                        <div class="bg-gray-50 rounded-lg p-6 text-center">
                            <div id="targetEmotion" class="text-4xl mb-3">üòê</div>
                            <div id="targetEmotionText" class="text-xl font-medium text-gray-800">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                            <p class="text-gray-600 mt-2">
                                –ó–∞–ø–∏—à–∏—Ç–µ —Ñ—Ä–∞–∑—É —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —ç–º–æ—Ü–∏–µ–π –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                            </p>
                            <input type="hidden" id="selectedEmotion" name="emotion">
                        </div>
                    </div>

                    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å
                        </label>
                        <div id="dragArea" class="drag-area rounded-lg p-8 text-center cursor-pointer">
                            <div class="space-y-4">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <div class="text-gray-600">
                                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
                                </div>
                                <div class="text-sm text-gray-500">
                                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è WAV —Ñ–∞–π–ª—ã, –º–∞–∫—Å–∏–º—É–º 1 –ú–ë
                                </div>
                            </div>
                            <input type="file" id="fileInput" accept=".wav" class="hidden">
                        </div>
                    </div>

                    <!-- –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ -->
                    <div class="border-t pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <button type="button" id="recordButton"
                                class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                <span id="recordIcon" class="mr-2">‚ö™</span>
                                <span id="recordText">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</span>
                            </button>
                            <span id="recordingTime" class="text-gray-600 hidden">00:00</span>
                        </div>
                        <div id="recordingStatus" class="text-sm text-gray-500"></div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div class="flex justify-center pt-6">
                        <button type="submit"
                            class="px-8 py-3 bg-purple-600 text-white rounded-full hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transform transition-transform hover:scale-105">
                            –ù–∞—á–∞—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                        </button>
                    </div>
                </form>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
            <div id="identificationResults" class="container-box rounded-xl shadow-xl p-8 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h2>
                
                <div class="space-y-6">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–∞ -->
                    <div class="p-4 rounded-lg" id="voiceResult">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" id="voiceIcon"></div>
                            <div>
                                <h3 class="text-lg font-medium" id="voiceTitle"></h3>
                                <p class="text-gray-600" id="voiceMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç–º–æ—Ü–∏–∏ -->
                    <div class="p-4 rounded-lg" id="emotionResult">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" id="emotionIcon"></div>
                            <div>
                                <h3 class="text-lg font-medium" id="emotionTitle"></h3>
                                <p class="text-gray-600" id="emotionMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞" -->
                    <div class="flex justify-center pt-4">
                        <button onclick="resetForm()" class="px-6 py-2 bg-gray-600 text-white rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–π —ç–º–æ—Ü–∏–∏
        const emotionEmojis = {
            'anger': 'üò†',
            'joy': 'üòä',
            'sadness': 'üò¢'
        };

        const emotionNames = {
            'anger': '–ì–Ω–µ–≤',
            'joy': '–†–∞–¥–æ—Å—Ç—å',
            'sadness': '–ì—Ä—É—Å—Ç—å'
        };

        async function getRandomEmotion() {
            try {
                const response = await fetch('/api/emotions');
                if (response.ok) {
                    const data = await response.json();
                    const emotion = data.emotion;
                    document.getElementById('targetEmotion').textContent = emotionEmojis[emotion] || 'üòê';
                    document.getElementById('targetEmotionText').textContent = emotionNames[emotion] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —ç–º–æ—Ü–∏—è';
                    document.getElementById('selectedEmotion').value = emotion;
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —ç–º–æ—Ü–∏–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('targetEmotionText').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —ç–º–æ—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', getRandomEmotion);

        // Drag and drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
        const dragArea = document.getElementById('dragArea');
        const fileInput = document.getElementById('fileInput');

        dragArea.addEventListener('click', () => fileInput.click());

        dragArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragArea.classList.add('dragover');
        });

        dragArea.addEventListener('dragleave', () => {
            dragArea.classList.remove('dragover');
        });

        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            if (files.length > 1) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª');
                return;
            }

            const file = files[0];
            if (file.size > 1024 * 1024) {
                alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 1 –ú–ë');
                return;
            }

            dragArea.querySelector('.text-gray-600').textContent = `–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª: ${file.name}`;
        }

        // –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞
        let mediaRecorder;
        let recordedChunks = [];
        let startTime;
        let timeInterval;

        const recordButton = document.getElementById('recordButton');
        const recordIcon = document.getElementById('recordIcon');
        const recordText = document.getElementById('recordText');
        const recordingTime = document.getElementById('recordingTime');
        const recordingStatus = document.getElementById('recordingStatus');

        recordButton.addEventListener('click', toggleRecording);

        async function toggleRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.addEventListener('dataavailable', handleDataAvailable);
                    mediaRecorder.addEventListener('stop', handleStop);
                    
                    mediaRecorder.start();
                    startRecording();
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err);
                }
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            recordedChunks = [];
            recordButton.classList.add('bg-red-600');
            recordIcon.textContent = '‚ö´';
            recordIcon.classList.add('recording-animation');
            recordText.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            recordingTime.classList.remove('hidden');
            recordingStatus.textContent = '–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...';
            
            startTime = Date.now();
            timeInterval = setInterval(updateRecordingTime, 1000);
        }

        function stopRecording() {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            recordButton.classList.remove('bg-red-600');
            recordIcon.textContent = '‚ö™';
            recordIcon.classList.remove('recording-animation');
            recordText.textContent = '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
            clearInterval(timeInterval);
            recordingStatus.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            recordingTime.textContent = `${minutes}:${seconds}`;
        }

        function handleDataAvailable(event) {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        }

        function handleStop() {
            const blob = new Blob(recordedChunks, { type: 'audio/wav' });
            const file = new File([blob], `recording_${Date.now()}.wav`, { type: 'audio/wav' });
            handleFiles([file]);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        const identificationForm = document.getElementById('identificationForm');
        const identificationResults = document.getElementById('identificationResults');
        const voiceResult = document.getElementById('voiceResult');
        const voiceIcon = document.getElementById('voiceIcon');
        const voiceTitle = document.getElementById('voiceTitle');
        const voiceMessage = document.getElementById('voiceMessage');
        const emotionResult = document.getElementById('emotionResult');
        const emotionIcon = document.getElementById('emotionIcon');
        const emotionTitle = document.getElementById('emotionTitle');
        const emotionMessage = document.getElementById('emotionMessage');

        identificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedEmotionInput.value) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–±—É–µ–º–æ–π —ç–º–æ—Ü–∏–∏');
                return;
            }

            if (!fileInput.files.length) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('emotion', selectedEmotionInput.value);

            try {
                const response = await fetch('/api/identify', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    showResults(result);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
                }
            } catch (error) {
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
            }
        });

        function showResults(result) {
            identificationForm.classList.add('hidden');
            identificationResults.classList.remove('hidden');

            // –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–∞
            if (result.voice_match) {
                voiceResult.classList.add('bg-green-50');
                voiceIcon.innerHTML = '‚úÖ';
                voiceIcon.classList.add('bg-green-100');
                voiceTitle.textContent = '–ì–æ–ª–æ—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω';
                voiceMessage.textContent = '–°–∏—Å—Ç–µ–º–∞ —É—Å–ø–µ—à–Ω–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞ –≤–∞—à –≥–æ–ª–æ—Å';
            } else {
                voiceResult.classList.add('bg-red-50');
                voiceIcon.innerHTML = '‚ùå';
                voiceIcon.classList.add('bg-red-100');
                voiceTitle.textContent = '–ì–æ–ª–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω';
                voiceMessage.textContent = '–°–∏—Å—Ç–µ–º–∞ –Ω–µ —Å–º–æ–≥–ª–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –≥–æ–ª–æ—Å';
            }

            // –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç–º–æ—Ü–∏–∏
            if (result.emotion_match) {
                emotionResult.classList.add('bg-green-50');
                emotionIcon.innerHTML = '‚úÖ';
                emotionIcon.classList.add('bg-green-100');
                emotionTitle.textContent = '–≠–º–æ—Ü–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç';
                emotionMessage.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —ç–º–æ—Ü–∏—è: ${emotionNames[result.predicted_emotion]}`;
            } else {
                emotionResult.classList.add('bg-yellow-50');
                emotionIcon.innerHTML = '‚ö†Ô∏è';
                emotionIcon.classList.add('bg-yellow-100');
                emotionTitle.textContent = '–≠–º–æ—Ü–∏—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç';
                emotionMessage.textContent = `–¢—Ä–µ–±–æ–≤–∞–ª–∞—Å—å —ç–º–æ—Ü–∏—è: ${emotionNames[selectedEmotionInput.value]}, —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞: ${emotionNames[result.predicted_emotion]}`;
            }
        }

        function resetForm() {
            identificationForm.classList.remove('hidden');
            identificationResults.classList.add('hidden');
            
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            identificationForm.reset();
            dragArea.querySelector('.text-gray-600').textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞';
            
            // –°–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            voiceResult.className = 'p-4 rounded-lg';
            emotionResult.className = 'p-4 rounded-lg';
            voiceIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center mr-4';
            emotionIcon.className = 'w-12 h-12 rounded-full flex items-center justify-center mr-4';

            // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—É—é —Å–ª—É—á–∞–π–Ω—É—é —ç–º–æ—Ü–∏—é
            getRandomEmotion();
        }
    </script>
</body>
</html> 